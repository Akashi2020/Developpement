let gamestats = ['!help', 'Youtube | https://www.youtube.com/channel/UCLONIS9KOOZ6p7ULXOG1ujA?view_as=subscriber', 'D√©velopper par Akashi#2020'];

  const invites = {};

const wait = require('util').promisify(setTimeout);

client.on('ready', () => {
  wait(1000);

  client.guilds.cache.forEach(g => {
    g.fetchInvites().then(guildInvites => {
      invites[g.id] = guildInvites;
    });
  });
});

client.on('guildMemberAdd', member => {
      member.guild.fetchInvites().then(guildInvites => {
        const ei = invites[member.guild.id];
        invites[member.guild.id] = guildInvites;
        const invite = guildInvites.find(i => ei.get(i.code).uses < i.uses);
        const inviter = client.users.cache.get(invite.inviter.id);
      const logChannel = member.guild.channels.cache.find(channel => channel.name === "üìà‚îÇinvitations");
      let embed = new Discord.MessageEmbed()
              .setColor('F26A0C')
              .setDescription(`${member.user.tag} a √©t√© inviter par ${inviter.tag} qui a un total d'invitation de ${invite.uses} membre(s) avec cette invitation: ${invite}`);
        logChannel.send(embed)
    });
  });

client.on('guildMemberAdd', member => {

  let memberavatar = member.user.displayAvatarURL({ dynamic: true })
      let embed = new Discord.MessageEmbed()
      .setColor('F26A0C')
      .setThumbnail(memberavatar)
      .addField(':bust_in_silhouette: | Nom : ', `${member}`)
      .addField(':microphone2: | Bienvenue !', `Bienvenue sur Community-Faction, ${member}`)
      .addField(':id: | ID d\'utilisateur :', "**[" + `${member.id}` + "]**")
      .addField('üë™ | Gr√¢ce √† toi nous sommes', `${member.guild.memberCount}`)
      .setFooter(`${member.guild.name}`)
      .setTimestamp()

      const channel = client.channels.cache.get('752193150378049667');
      channel.send(embed);
});

client.on('guildMemberAdd', member => {

  console.log(`${member}`, " √† rejoint" + ` ${member.guild.name}`)

});

client.on('guildMemberRemove', member => {
  console.log(`${member}` + " est parti de" + ` ${member.guild.name}` + " Envoi d'un message de d√©part maintenant")
  console.log("Laisser le message envoy√©")
});

fs.readdir('./Commandes/', (error, f) => {
    if (error) { return console.error(error); }
        let commandes = f.filter(f => f.split('.').pop() === 'js');
        if (commandes.length <= 0) { return console.log('Aucune commande trouv√©e !'); }

        commandes.forEach((f) => {
            let commande = require(`./Commandes/${f}`);
            console.log(`${f} commande charg√©e !`);
            client.commands.set(commande.help.name, commande);
        });
});

client.on('ready', async () => {
    console.log(`Votre bot est en ligne`);
    setInterval(function() {
        let games = gamestats[Math.floor(Math.random()*gamestats.length)];
        client.user.setPresence({ activity: { name: games, type: 'WATCHING' }, status: 'dnd' });
    }, 5000)
});

client.on('message', async (message) => {
    if(message.author.bot) return;
      message.guild === null;
  
  
      let prefix = prefixconfig
      let messageArray = message.content.split(" ");
      let cmd = messageArray[0];
      let args = messageArray.slice(1);
  
      if(message.content.startsWith(prefix)) {
      let commandfile = client.commands.get(cmd.slice(prefix.length));
      if(commandfile) commandfile.run(client,message,args);
      }

  //Anti-pseudo + Anti-raid
  client.on('guildMemberAdd', member => {
  
      //Anti-pseudo
      if (ynPseudo == 1){
        function antipseudo() {
          const banpseudoEmbed = new Discord.MessageEmbed()
          .setColor('#FF0000')
          .setAuthor(guild, guildImage)
          .setTitle(':no_entry: Vous avez √©t√© banni.')
          .setDescription(nom + " vous a banni automatiquement.")
          .addField('Motif', 'Pseudo innapropri√©')
        
          const user = client.users.cache.get(`${member.id}`);
          user.send(banpseudoEmbed);
        
          const channel = client.channels.cache.get(modchannelbisid);
          channel.send(`:no_entry: ${member.user.tag} a √©t√© banni automatiquement pour pseudo innapropri√©.`);
        
          console.log(`${member.user.tag} banni pour pseudo innapropri√©.`);
        
          function banpseudo() { member.ban({ days: 0, reason: 'Pseudo innapropri√©' }) }
        
          setTimeout(banpseudo, 1000); 
        }
  
        const has= (a,b)=> {
          for(let c in a) {
              if(b.includes(a[c])) return c;
          } return false;
      };
  
        let pseudointerditbis = pseudointerdit,
          interdit= has(pseudointerditbis, member.displayName.toLowerCase());
        if(interdit) {
          setTimeout(antipseudo, 100); 
        } else {
      }
  
        //Anti-raid
        if (ynRaid == 1){
  
          fs.readFile('raidVar.json', function(erreur, fichier) {
            let raidVar = JSON.parse(fichier)
       
            var nudate=new Date()
            var d=nudate.getDate();
            if (d<10) {d = "0" + d}
            var mo=nudate.getMonth();
            if (mo<10) {mo = "0" + mo}
            var y=nudate.getFullYear();
            if (y<10) {y = "0" + y}
            var h=nudate.getHours();
            if (h<10) {h = "0" + h}
            var m=nudate.getMinutes();
            if (m<10) {m = "0" + m}
            var s=nudate.getSeconds();
            if (s<10) {s = "0" + s}
            var thisdate = (y+mo+d+h+m+s)
  
            if(raidVar.RaidMemberAdd !== 999){
              if((raidVar.ludate - thisdate) >= raiddelais){
                ++raidVar.RaidMemberAdd
              }
  
              if((raidVar.ludate - thisdate) < raiddelais){
                if(raidVar.RaidMemberAdd >= raidon){
  
                  const offraidEmbed = new Discord.MessageEmbed()
                  .setColor('#2a4b8d')
                  .setTitle(':shield: Mode anti-raid d√©sactiv√©.')
                  .setDescription(nom + " a d√©sactiv√© le mode anti-raid automatiquement.")
  
                  const channel = client.channels.cache.get(modchannelid);
                  channel.send(offraidEmbed)
  
                  console.log('Mode anti-raid d√©sactiv√©.')
                }
                raidVar.RaidMemberAdd = 1
              }
            }
  
            if(raidVar.RaidMemberAdd >= raidon){
  
              if(raidVar.RaidMemberAdd === raidon){
  
                const onraidEmbed = new Discord.MessageEmbed()
                .setColor('#2a4b8d')
                .setTitle(':shield: Mode anti-raid actif.')
                .setDescription(nom + " a activ√© le mode anti-raid automatiquement.")
                .addField('Motif', 'Trop de nouveaux utilisateurs en m√™me temps.')
                .addField('Cooldown', `Fin de la proc√©dure dans ${raiddelaisH}.`)
                .addField('Arr√™t', `En cas d'abus, utilisez !raid off.`)
  
                const channel = client.channels.cache.get(modchannelid);
                channel.send(onraidEmbed)
  
                console.log('Mode anti-raid actif.')
  
              }
                const kickraidEmbed = new Discord.MessageEmbed()
                .setColor('#2a4b8d')
                .setAuthor(guild, guildImage)
                .setTitle(':shield: Vous avez √©t√© expuls√©.')
                .setDescription(nom + " vous a expuls√© automatiquement.")
                .addField('Motif', 'Vous avez rejoint le serveur en p√©riode de raid, r√©essayez plus tard.')
                .addField('Invitation', `Voici le [lien du serveur](https://discord.gg/${invitation}).`)
              
                const user = client.users.cache.get(`${member.id}`);
                user.send(kickraidEmbed);
              
                const channel = client.channels.cache.get(modchannelbisid);
                channel.send(`:shield: ${member.user.tag} a √©t√© expuls√© automatiquement car il a rejoint en p√©riode de raid.`);
              
                console.log(`${member.user.tag} expuls√© par le mode anti-raid.`);
              
                function kickraid() { member.kick('Mode anti-raid actif') }
              
                setTimeout(kickraid, 1000); 
            }
  
            if(raidVar.RaidMemberAdd !== 999){
              raidVar.ludate = (y+mo+d+h+m+s)
  
  
              fs.writeFileSync('./raidVar.json', `
  {
    "ludate": ${raidVar.ludate},
    "RaidMemberAdd": ${raidVar.RaidMemberAdd}
  }
              `, function (err) {
                if (err) return console.log(err);
              })
            }
          })
        }
      }
  });
